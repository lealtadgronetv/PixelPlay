<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Cuentas Netflix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>Gestión de Cuentas Netflix</h1>
    
    <h2>Agregar Cuenta Completa</h2>
    <form id="addAccountForm">
        <label for="correo">Correo:</label>
        <input type="email" id="correo" required>
        
        <label for="contraseña">Contraseña:</label>
        <input type="password" id="contraseña" required>
        
        <label for="plataforma">Plataforma:</label>
        <input type="text" id="plataforma" required>
        
        <label for="perfiles">Perfiles Disponibles:</label>
        <input type="number" id="perfiles" required>
        
        <label for="fecha_vencimiento">Fecha de Vencimiento:</label>
        <input type="date" id="fecha_vencimiento" required>
        
        <button type="submit">Agregar Cuenta</button>
    </form>
    
    <h2>Asignar Perfil a Cliente</h2>
    <form id="assignProfileForm">
        <label for="nombre_cliente">Nombre Cliente:</label>
        <input type="text" id="nombre_cliente" required>
        
        <label for="nombre_perfil">Nombre del Perfil:</label>
        <input type="text" id="nombre_perfil" required>
        
        <label for="cuenta">Seleccionar Cuenta:</label>
        <select id="cuenta" required></select>
        
        <button type="submit">Asignar Perfil</button>
    </form>
    
    <h2>Lista de Cuentas</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Correo</th>
                <th>Plataforma</th>
                <th>Perfiles Disponibles</th>
                <th>Fecha Vencimiento</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="accountList"></tbody>
    </table>
    
    <h2>Lista de Perfiles Asignados</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre Cliente</th>
                <th>Nombre del Perfil</th>
                <th>Cuenta Asociada</th>
                <th>Fecha Vencimiento</th>
            </tr>
        </thead>
        <tbody id="profileList"></tbody>
    </table>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://vdsdtouiokgvzrscaroe.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkc2R0b3Vpb2tndnpyc2Nhcm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEyMTU1NjQsImV4cCI6MjA1Njc5MTU2NH0.zZ_PsL3vXmNNaaWWu9yHGdYn7vfYhzH4jpAwyG9tJqA';
        const supabase = createClient(supabaseUrl, supabaseKey);

        async function fetchAccounts() {
            const { data, error } = await supabase.from('netflix').select('*');
            if (error) console.error(error);
            else renderAccounts(data);
        }

        async function fetchProfiles() {
            const { data, error } = await supabase.from('clientes').select('id, nombre_cliente, nombre_perfil, cuenta_id, netflix(fecha_vencimiento)');
            if (error) console.error(error);
            else renderProfiles(data);
        }

        function renderAccounts(accounts) {
            const tableBody = document.getElementById('accountList');
            const selectAccount = document.getElementById('cuenta');
            tableBody.innerHTML = '';
            selectAccount.innerHTML = '';
            accounts.forEach(account => {
                if (account.perfiles > 0) {
                    selectAccount.innerHTML += `<option value="${account.id}">${account.correo} - ${account.perfiles} perfiles</option>`;
                }
                const row = `<tr>
                    <td>${account.id}</td>
                    <td>${account.correo}</td>
                    <td>${account.plataforma}</td>
                    <td>${account.perfiles}</td>
                    <td>${account.fecha_vencimiento}</td>
                    <td><button onclick="deleteAccount(${account.id})">Eliminar</button></td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function renderProfiles(profiles) {
            const tableBody = document.getElementById('profileList');
            tableBody.innerHTML = '';
            profiles.forEach(profile => {
                const row = `<tr>
                    <td>${profile.id}</td>
                    <td>${profile.nombre_cliente}</td>
                    <td>${profile.nombre_perfil}</td>
                    <td>${profile.cuenta_id}</td>
                    <td>${profile.netflix ? profile.netflix.fecha_vencimiento : ''}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        async function addAccount(event) {
            event.preventDefault();
            const correo = document.getElementById('correo').value;
            const contraseña = document.getElementById('contraseña').value;
            const plataforma = document.getElementById('plataforma').value;
            const perfiles = document.getElementById('perfiles').value;
            const fecha_vencimiento = document.getElementById('fecha_vencimiento').value;
            
            await supabase.from('netflix').insert([{ correo, contraseña, plataforma, perfiles, fecha_vencimiento }]);
            fetchAccounts();
        }

        async function assignProfile(event) {
            event.preventDefault();
            const cuentaId = document.getElementById('cuenta').value;
            const nombre_cliente = document.getElementById('nombre_cliente').value;
            const nombre_perfil = document.getElementById('nombre_perfil').value;
            
            await supabase.from('clientes').insert([{ cuenta_id: cuentaId, nombre_cliente, nombre_perfil }]);
            fetchProfiles();
        }

        async function deleteAccount(id) {
            await supabase.from('netflix').delete().eq('id', id);
            fetchAccounts();
        }

        document.getElementById('addAccountForm').addEventListener('submit', addAccount);
        document.getElementById('assignProfileForm').addEventListener('submit', assignProfile);
        document.addEventListener('DOMContentLoaded', () => { fetchAccounts(); fetchProfiles(); });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Cuentas Netflix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <h1>Gestión de Cuentas Netflix</h1>
    
    <h2>Agregar Cuenta Completa</h2>
    <form id="addAccountForm">
        <label for="correo">Correo:</label>
        <input type="email" id="correo" required>
        
        <label for="contraseña">Contraseña:</label>
        <input type="password" id="contraseña" required>
        
        <label for="plataforma">Plataforma:</label>
        <input type="text" id="plataforma" required>
        
        <label for="perfiles">Perfiles Disponibles:</label>
        <input type="number" id="perfiles" required>
        
        <label for="fecha_vencimiento">Fecha de Vencimiento:</label>
        <input type="date" id="fecha_vencimiento" required>
        
        <button type="submit">Agregar Cuenta</button>
    </form>
    
    <h2>Asignar Perfil a Cliente</h2>
    <form id="assignProfileForm">
        <label for="nombre_cliente">Nombre Cliente:</label>
        <input type="text" id="nombre_cliente" required>
        
        <label for="nombre_perfil">Nombre del Perfil:</label>
        <input type="text" id="nombre_perfil" required>
        
        <label for="cuenta">Seleccionar Cuenta:</label>
        <select id="cuenta" required></select>
        
        <button type="submit">Asignar Perfil</button>
    </form>
    
    <h2>Lista de Cuentas</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Correo</th>
                <th>Plataforma</th>
                <th>Perfiles Disponibles</th>
                <th>Fecha Vencimiento</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="accountList"></tbody>
    </table>
    
    <h2>Lista de Perfiles Asignados</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre Cliente</th>
                <th>Nombre del Perfil</th>
                <th>Cuenta Asociada</th>
                <th>Fecha Vencimiento</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="profileList"></tbody>
    </table>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = 'https://vdsdtouiokgvzrscaroe.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkc2R0b3Vpb2tndnpyc2Nhcm9lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEyMTU1NjQsImV4cCI6MjA1Njc5MTU2NH0.zZ_PsL3vXmNNaaWWu9yHGdYn7vfYhzH4jpAwyG9tJqA';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Exponer la función deleteAccount al ámbito global
        window.deleteAccount = async function(id) {
            await supabase.from('netflix').delete().eq('id', id);
            fetchAccounts();
            fetchProfiles();
        };

        // Exponer la función deleteProfile al ámbito global
        window.deleteProfile = async function(id, cuentaId) {
            try {
                // Primero obtenemos la información de la cuenta para actualizar los perfiles disponibles
                const { data: accountData, error: accountError } = await supabase
                    .from('netflix')
                    .select('perfiles')
                    .eq('id', cuentaId)
                    .single();
                
                if (accountError) throw accountError;
                
                // Eliminar el perfil
                const { error: deleteError } = await supabase
                    .from('clientes')
                    .delete()
                    .eq('id', id);
                
                if (deleteError) throw deleteError;
                
                // Actualizar los perfiles disponibles (+1)
                const { error: updateError } = await supabase
                    .from('netflix')
                    .update({ perfiles: accountData.perfiles + 1 })
                    .eq('id', cuentaId);
                
                if (updateError) throw updateError;
                
                fetchAccounts();
                fetchProfiles();
            } catch (error) {
                console.error("Error al eliminar el perfil:", error);
                alert("Ocurrió un error al eliminar el perfil. Consulta la consola para más detalles.");
            }
        };

        async function fetchAccounts() {
            const { data, error } = await supabase.from('netflix').select('*');
            if (error) console.error(error);
            else renderAccounts(data);
        }

        async function fetchProfiles() {
            const { data, error } = await supabase
                .from('clientes')
                .select('id, nombre_cliente, nombre_perfil, cuenta_id, netflix(correo, fecha_vencimiento)');
            if (error) console.error(error);
            else renderProfiles(data);
        }

        function renderAccounts(accounts) {
            const tableBody = document.getElementById('accountList');
            const selectAccount = document.getElementById('cuenta');
            tableBody.innerHTML = '';
            selectAccount.innerHTML = '';
            accounts.forEach(account => {
                if (account.perfiles > 0) {
                    selectAccount.innerHTML += `<option value="${account.id}">${account.correo} - ${account.perfiles} perfiles</option>`;
                }
                const row = `<tr>
                    <td>${account.id}</td>
                    <td>${account.correo}</td>
                    <td>${account.plataforma}</td>
                    <td>${account.perfiles}</td>
                    <td>${account.fecha_vencimiento}</td>
                    <td><button onclick="deleteAccount(${account.id})">Eliminar</button></td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        function renderProfiles(profiles) {
            const tableBody = document.getElementById('profileList');
            tableBody.innerHTML = '';
            profiles.forEach(profile => {
                const row = `<tr>
                    <td>${profile.id}</td>
                    <td>${profile.nombre_cliente}</td>
                    <td>${profile.nombre_perfil}</td>
                    <td>${profile.netflix ? profile.netflix.correo : 'N/A'}</td>
                    <td>${profile.netflix ? profile.netflix.fecha_vencimiento : 'N/A'}</td>
                    <td><button onclick="deleteProfile(${profile.id}, ${profile.cuenta_id})">Eliminar</button></td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        }

        async function addAccount(event) {
            event.preventDefault();
            const correo = document.getElementById('correo').value;
            const contraseña = document.getElementById('contraseña').value;
            const plataforma = document.getElementById('plataforma').value;
            const perfiles = parseInt(document.getElementById('perfiles').value);
            const fecha_vencimiento = document.getElementById('fecha_vencimiento').value;
            
            const { error } = await supabase.from('netflix').insert([{ 
                correo, 
                contraseña, 
                plataforma, 
                perfiles, 
                fecha_vencimiento 
            }]);
            
            if (error) {
                console.error("Error al agregar cuenta:", error);
                alert("Error al agregar la cuenta. Consulta la consola para más detalles.");
            } else {
                document.getElementById('addAccountForm').reset();
                fetchAccounts();
            }
        }

        async function assignProfile(event) {
            event.preventDefault();
            const cuentaId = parseInt(document.getElementById('cuenta').value);
            const nombre_cliente = document.getElementById('nombre_cliente').value;
            const nombre_perfil = document.getElementById('nombre_perfil').value;
            
            try {
                // Obtener información de la cuenta
                const { data: accountData, error: accountError } = await supabase
                    .from('netflix')
                    .select('perfiles')
                    .eq('id', cuentaId)
                    .single();
                
                if (accountError) throw accountError;
                
                if (accountData.perfiles <= 0) {
                    alert("Esta cuenta no tiene perfiles disponibles.");
                    return;
                }
                
                // Agregar el perfil
                const { error: insertError } = await supabase
                    .from('clientes')
                    .insert([{ cuenta_id: cuentaId, nombre_cliente, nombre_perfil }]);
                
                if (insertError) throw insertError;
                
                // Actualizar los perfiles disponibles (-1)
                const { error: updateError } = await supabase
                    .from('netflix')
                    .update({ perfiles: accountData.perfiles - 1 })
                    .eq('id', cuentaId);
                
                if (updateError) throw updateError;
                
                document.getElementById('assignProfileForm').reset();
                fetchAccounts();
                fetchProfiles();
            } catch (error) {
                console.error("Error al asignar perfil:", error);
                alert("Ocurrió un error al asignar el perfil. Consulta la consola para más detalles.");
            }
        }

        document.getElementById('addAccountForm').addEventListener('submit', addAccount);
        document.getElementById('assignProfileForm').addEventListener('submit', assignProfile);
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => { 
            fetchAccounts(); 
            fetchProfiles(); 
        });
    </script>
</body>
</html>
